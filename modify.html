<!DOCTYPE html>
<html>
<body style="
margin:0;
background:transparent;
color:white;
font-family:system-ui;
overflow:hidden;
">

<button id="fxBtn" style="
position:absolute;
top:20px;
left:20px;
z-index:10;
">FX OFF</button>

<input type="file" id="fileInput" accept="audio/*" style="display:none;">

<canvas id="canvas"></canvas>

<script>
let ctx;
let source;
let lowFilter, highFilter;
let distortion;
let audioBuffer;
let fxEnabled = false;
let audioLoaded = false;

const canvas = document.getElementById("canvas");
const c = canvas.getContext("2d");

resize();
window.addEventListener("resize", resize);

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}

function init(){
  if(!ctx){
    ctx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

document.getElementById("fxBtn").onclick = () => {
  init();

  if(!audioLoaded){
    document.getElementById("fileInput").click();
  } else {
    toggleFX();
  }
};

document.getElementById("fileInput").addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  const arrayBuffer = await file.arrayBuffer();
  audioBuffer = await ctx.decodeAudioData(arrayBuffer);
  audioLoaded = true;
  startPlayback();
});

function startPlayback(){
  if(source) source.stop();

  source = ctx.createBufferSource();
  source.buffer = audioBuffer;
  source.loop = true;

  lowFilter = ctx.createBiquadFilter();
  lowFilter.type = "lowpass";

  highFilter = ctx.createBiquadFilter();
  highFilter.type = "highpass";

  distortion = ctx.createWaveShaper();
  distortion.curve = makeDistortionCurve(400);
  distortion.oversample = "4x";

  source.connect(lowFilter);
  source.connect(highFilter);

  lowFilter.connect(ctx.destination);
  highFilter.connect(ctx.destination);

  source.start();
}

function toggleFX(){
  fxEnabled = !fxEnabled;
  document.getElementById("fxBtn").innerText = fxEnabled ? "FX ON" : "FX OFF";

  if(fxEnabled){
    highFilter.disconnect();
    highFilter.connect(distortion);
    distortion.connect(ctx.destination);
  } else {
    highFilter.disconnect();
    distortion.disconnect();
    highFilter.connect(ctx.destination);
  }
}

function makeDistortionCurve(amount){
  const n_samples = 44100;
  const curve = new Float32Array(n_samples);
  const deg = Math.PI / 180;

  for(let i = 0; i < n_samples; ++i){
    const x = i * 2 / n_samples - 1;
    curve[i] = (3 + amount) * x * 20 * deg /
      (Math.PI + amount * Math.abs(x));
  }
  return curve;
}

let drawing = false;

canvas.addEventListener("pointerdown", (e)=>{
  drawing = true;
  updateSplit(e);
});

canvas.addEventListener("pointermove", (e)=>{
  if(drawing) updateSplit(e);
});

canvas.addEventListener("pointerup", ()=>{
  drawing = false;
});

function updateSplit(e){
  if(!lowFilter || !highFilter) return;

  const y = e.clientY;
  const height = canvas.height;
  const ratio = 1 - (y / height);

  const minFreq = 100;
  const maxFreq = 8000;
  const freq = minFreq + ratio * (maxFreq - minFreq);

  lowFilter.frequency.value = freq;
  highFilter.frequency.value = freq;

  drawLine(y);
}

function drawLine(y){
  c.clearRect(0,0,canvas.width,canvas.height);
  c.strokeStyle = "#ff0066";
  c.lineWidth = 3;
  c.beginPath();
  c.moveTo(0,y);
  c.lineTo(canvas.width,y);
  c.stroke();
}
</script>

</body>
</html>
